= Transferencia de calor
:experimental:
:nofooter:
:source-highlighter: pygments
:sectnums:
:stem: latexmath
:toc:
:xrefstyle: short


[[problem_statement]]
== Problem statement

Se necesita una sencilla simulaci√≥n por computadora que ayude a encontrar el momento de equilibro t√©rmico de una l√°mina rectangular a la que se le inyecta calor constante por su borde. La l√°mina (en ingl√©s, plate) corresponde a un rect√°ngulo de dos dimensiones de un mismo material. Para efectos de la simulaci√≥n, el rect√°ngulo es dividido en ùëÖ filas y ùê∂ columnas ambas de igual alto y ancho ‚Ñé como se ve en la Figura 1. Esto genera una matriz cuyas celdas son todas cuadradas, de ancho y alto ‚Ñé.

image::images/1.png[width=400]

Cada celda de la matriz almacena una temperatura, la cual puede cambiar en el tiempo. Se usa la notaci√≥n ùëáùëòùëñ,ùëó para indicar la temperatura de la celda ubicada en la fila ùëñ, columna ùëó, en el instante o estado ùëò. Despu√©s de transcurrido un tiempo Œîùë°, la simulaci√≥n pasar√° del instante ùëò al instante ùëò+1, y la temperatura en la l√°mina habr√° variado (estado). Como es sabido, la energ√≠a se transfiere de un √°rea m√°s caliente hacia una m√°s fr√≠a. La nueva temperatura en la celda (ùëñ,ùëó) ser√° ùëáùëò+1ùëñ,ùëó como se ve en la parte derecha de la Figura 1, y puede estimarse a partir de su temperatura en el instante (o estado) anterior y la temperatura de sus celdas vecinas por la relaci√≥n:

image::images/formula.png[width=400]

De acuerdo a la relaci√≥n anterior, la temperatura de una celda en el instante o estado ùëò+1 indicado por ùëáùëò+1ùëñ,ùëó, es el resultado de la temperatura que la celda ten√≠a en el instante o estado anterior ùëáùëòùëñ,ùëó m√°s la p√©rdida o ganancia de energ√≠a que la celda haya sufrido con sus inmediaciones durante ese per√≠odo Œîùë°. Para efecto de la simulaci√≥n, las inmediaciones son las cuatro celdas vecinas en forma de cruz como se ve en la Figura 1. Esta transferencia de energ√≠a o calor est√° regida por:

- La energ√≠a que la celda ùëñ,ùëó recibe de sus inmediaciones, y se calcula como la suma de las temperaturas de las cuatro vecinas ùëáùëòùëñ‚àí1,ùëó+ùëáùëòùëñ,ùëó+1+ùëáùëòùëñ+1,ùëó+ùëáùëòùëñ,ùëó‚àí1.

- La energ√≠a que la celda pierde y se distribuye a sus cuatro celdas vecinas, calculada como ‚àí4ùëáùëòùëñ,ùëó.

- La transferencia no es instant√°nea, sino que depende del √°rea que recorre. Entre mayor es el √°rea de la celda, m√°s tiempo requerir√° la energ√≠a para desplazarse y equilibrarse con sus vecinas. Por eso la ganancia y p√©rdida de energ√≠a calculada en los dos puntos anteriores, se divide entre el √°rea de la celda ‚Ñé2.

- La cantidad de energ√≠a transferida es proporcional al tiempo. Es decir, entre m√°s tiempo Œîùë° se permita entre el estado ùëò y el estado ùëò+1, m√°s energ√≠a podr√° intercambiar la celda con sus vecinas. Por esto, el intercambio de energ√≠a calculado en los puntos anteriores se multiplica por la duraci√≥n del estado Œîùë°.

- La cantidad de energ√≠a intercambiada en el periodo de tiempo depende de la calidad conductora de la l√°mina. Materiales como la madera son lentos para transmitir energ√≠a, mientras que los metales son eficientes para este fin. Para reflejar esta realidad, el intercambio de energ√≠a calculado en los puntos anteriores se multiplica por la difusividad t√©rmica, que corresponde a una constante Œ± que indica a qu√© tasa el material logra transmitir energ√≠a desde un punto caliente hacia otro fr√≠o a trav√©s de √©l. Sus unidades son de √°rea entre tiempo, como ùëö2ùë† √≥ ùëöùëö2ùë†. Por ejemplo, la madera tiene una difusividad cercana a 0.08ùëöùëö2ùë† mientras que el oro de 127ùëöùëö2ùë†, es decir, el oro transfiere calor aproximadamente 1500 veces m√°s r√°pido que la madera.

=== Simulaci√≥n de calor

La Figura 2 muestra cuatro instantes o estados de una simulaci√≥n hipot√©tica de una l√°mina de oro (difusividad t√©rmica Œ±=127ùëöùëö2ùë†). Para efectos de la simulaci√≥n, la l√°mina fue dividida en 5 filas y 4 columnas, cuyas celdas son de ‚Ñé=1000ùëöùëö de lado, es decir, de un metro de ancho por un metro de alto.

En el estado o instante cero (ùëò=0) la simulaci√≥n carga la matriz de un archivo que indica las temperaturas iniciales de cada celda de la l√°mina. Es importante resaltar que los bordes de la l√°mina no cambian su temperatura en el tiempo, dado que es el punto donde las personas experimentadoras "inyectan o retiran calor". Por esto los bordes se resaltan con color de fondo en la Figura 2. De esta figura puede verse que en la parte superior se inyecta calor a una temperatura constante de 10 unidades (Celcius, Farenheit, o Kelvin), y conforme se desciende en la l√°mina, se provee menos calor en los bordes.

image::images/2.png[width=400]

En cada instante o estado, la simulaci√≥n debe actualizar las celdas internas de la l√°mina de acuerdo al modelo f√≠sico presentado en la secci√≥n anterior. En el instante o estado ùëò=1 habr√°n transcurrido ùëòŒîùë°=1200ùë†=20min. Como puede verse en la Figura 2, las temperaturas en los bordes se mantienen constantes, pero las celdas internas han adquirido energ√≠a de los bordes, en especial las celdas en la parte superior. Sin embargo, la celda 2,2 perdi√≥ energ√≠a pese a que est√° al lado de un borde de temperatura 6, dado que tres de sus vecinas estaban m√°s fr√≠as que ella en el estado previo ùëò=0.

En el estado ùëò=2 habr√°n transcurrido ùëòŒîùë°=2‚ãÖ1200ùë†=40min. Como puede verse en la Figura 2, las celdas internas han incrementado lentamente su temperatura dado a que son de 1ùëö2 cada una. Incluso la celda 2,2 ha visto reflejado un incremento. En el estado ùëò=3 que en la vida real ocurrir√≠a una hora despu√©s de que inicia el experimento, la temperatura interna sigue creciendo, pero a√∫n no se ha equilibrado con los valores de los bordes.

Se desea que la simulaci√≥n contin√∫e hasta que se haya alcanzado el punto de equilibrio, lo cual ocurre cuando el calor se ha estabilizado en la l√°mina. Para esto se proveer√° un par√°metro √©psilon (Œµ) a la simulaci√≥n, que representa el m√≠nimo cambio de temperatura significativo en la l√°mina. En cada estado ùëò se actualizan todas las celdas internas de la l√°mina. Si al menos una de las celdas internas tiene un cambio en su temperatura mayor a Œµ, indica que no se ha alcanzado a√∫n el equilibrio y la simulaci√≥n contin√∫a con el siguiente estado ùëò+1, de lo contrario se detiene y reporta los resultados de la simulaci√≥n. Por ejemplo, si la simulaci√≥n de la Figura 2 se corriera con un Œµ=2 unidades de temperatura, √©sta terminar√≠a en el estado ùëò=2, dado que el cambio de temperatura m√°s grande del estado ùëò=1 a ùëò=2 se da en la celda 1,1, calculada como |4.51‚àí2.74|=1.77, y es menor que el Œµ=2.

El modelo f√≠sico presentado en la secci√≥n anterior es muy sensible a los par√°metros de entrada, y dependiendo de la combinaci√≥n de valores puede producir resultados incorrectos. El modelo se acerca m√°s a la realidad entre m√°s celdas se usen para representar la l√°mina (filas y columnas) y m√°s peque√±os sean los cambios de tiempo (Œîùë°). Sin embargo acercarse a la realidad impone m√°s presi√≥n sobre los recursos de la m√°quina, lo que hace la simulaci√≥n m√°s lenta, por lo que se desea una versi√≥n paralelizada de la simulaci√≥n, que pueda encontrar el punto de equilibrio t√©rmico en el menor tiempo posible.

=== Programa de simulaci√≥n

Se necesita que la soluci√≥n concurrente sea invocada desde la l√≠nea de comandos con los siguientes argumentos:

- El nombre de un archivo de trabajo (job). Es obligatorio. Si no se provee, se debe emitir un mensaje de error.

- La cantidad de hilos de ejecuci√≥n. Es opcional, y si se omite, se debe suponer la cantidad de CPUs disponibles en el sistema.

Por ejemplo, la siguiente invocaci√≥n indica que se quiere realizar todas las simulaciones indicadas en el archivo de trabajo job001.txt con 16 hilos de ejecuci√≥n.

[source, TXT]
----
bin/heatsim jobs/job001.txt 16
----

Nota: Cuando un usuario indica el nombre de un archivo, puede agregar la ruta (relativa o absoluta) donde √©ste se encuentra. A nivel de programaci√≥n en C/C++ no es necesario hacer un trabajo adicional para poder abrir los archivos, simplemente se usa el texto provisto por el usuario como nombre del archivo a abrir. El sistema operativo se encarga autom√°ticamente de resolver las rutas relativas o absolutas.

=== Archivo de trabajo

El archivo de trabajo (job file) es un archivo de texto que lista varias l√°minas y los par√°metros de simulaci√≥n que las personas experimentadoras quieren investigar en cada una de ellas. El siguiente es un ejemplo de un archivo de trabajo job001.txt:

[source, TXT]
----
plate001.bin 1200 127 1000 2
plate001.bin 1200 127 1000 1.5
plate002.bin 60 0.08 450 0.75
----

Cada l√≠nea del archivo de trabajo contiene una simulaci√≥n independiente de las dem√°s. Una simulaci√≥n consta de los siguientes par√°metros separados por espacios en blanco:

- Nombre del archivo que contiene la l√°mina en su estado inicial. El contenido de este archivo se explica m√°s adelante. La ubicaci√≥n del archivo de simulaci√≥n es relativo al archivo de trabajo. Por ejemplo si el anterior es el contenido del archivo de trabajo jobs/job001.txt significa que plate001.bin se encuentra tambi√©n en la subcarpeta jobs/plate001.bin. Una alternativa para trabajar con rutas se ofrece m√°s adelante.

- La duraci√≥n de cada etapa Œîùë° en segundos.

- La difusividad t√©rmica Œ± del material medida en unidades de √°rea entre tiempo, por ejemplo: ùëö2ùë† √≥ ùëöùëö2ùë†. Puede suponer que las unidades de tiempo siempre son las mismas que las usadas en el par√°metro anterior.

- Las dimensiones ‚Ñé de las celdas medidas en las mismas unidades de √°rea que el par√°metro anterior pero lineales (distancia).

- La sensitividad del punto de equilibrio Œµ, en las mismas unidades de temperatura que se usaron en el archivo de la l√°mina.

Su programa debe realizar todas las simulaciones indicadas en el archivo de trabajo. Una simulaci√≥n involucra cargar la l√°mina como una matriz en memoria, y actualizarla a lo largo de varios estados hasta que se haya alcanzado el punto de equilibrio t√©rmico. Una vez que esto ocurre se debe hacer un reporte a las personas investigadoras, como se indica en la pr√≥xima secci√≥n.

Nota: Como se indic√≥ anteriormente, los archivos de l√°minas son relativos al archivo de trabajo. Puede usar procesamiento de cadenas para extraer el prefijo del archivo de trabajo. Alternativamente puede solicitar un tercer argumento en l√≠nea de comandos al programa de simulaci√≥n que indica la ruta donde se encuentran todos los archivos. Por ejemplo:

[source, TXT]
----
bin/heatsim job001.txt 16 jobs
----

La instrucci√≥n anterior usar√≠a jobs/ como prefijo de ruta de todos los archivos. Es decir, provocar√≠a que el programa busque el archivo de trabajo jobs/job001.txt. Para cada l√°mina dentro de job001.txt tambi√©n se utilizar√≠a el prefijo, es decir jobs/plate001.bin, jobs/plate002.bin, etc.

=== Archivo de reporte

El archivo de reporte provee estad√≠sticas resultado de ejecutar cada simulaci√≥n. Su nombre tiene la forma job###.tsv, donde ### es el mismo n√∫mero del archivo de trabajo. Cada vez que se invoca el programa de simulaci√≥n, se crea o sobrescribe el archivo de reporte correspondiente. El archivo de reporte es de texto y tiene un formato similar al archivo de trabajo:

[source, TXT]
----
plate001.bin  1200   127  1000  2        2  0000/00/00  00:40:00
plate001.bin  1200   127  1000  1.5      3  0000/00/00  01:00:00
plate002.bin    60  0.08   450  0.75 56907  0000/01/09  12:27:00
----

Las l√≠neas del archivo de reporte coinciden con las del archivo de trabajo. Cada l√≠nea del reporte contiene los mismos valores del archivo de trabajo, pero separados por tabuladores, y agrega dos resultados:

- La cantidad de estados ùëò que transcurrieron hasta alcanzar el punto de equilibrio.

- El tiempo transcurrido ùëòŒîùë° hasta alcanzar el punto de equilibrio, pero reportado en formato legible para humanos YYYY/MM/DD hh:mm:ss donde, por sencillez, los meses son siempre de 30 d√≠as.

Para formatear el tiempo transcurrido en segundos, puede usar la siguiente funci√≥n:

[source, C]
----
// Return parameter text must have at least 48 chars (YYYY/MM/DD hh:mm:ss)
char* format_time(const time_t seconds, char* text, const size_t capacity) {
  const std::tm* gmt = gmtime(&seconds);
  snprintf(text, capacity, "%04d/%02d/%02d\t%02d:%02d:%02d", gmt->tm_year - 70,
      gmt->tm_mon, gmt->tm_mday - 1, gmt->tm_hour, gmt->tm_min, gmt->tm_sec);
  return text;
}
----

Las personas experimentadoras est√°n tambi√©n interesados en conocer el estado de la l√°mina una vez que haya alcanzado el punto de equilibrio. Por eso la simulaci√≥n debe crear ‚Äìo sobrescribir si ya existe‚Äì un archivo binario con el estado de la matriz en el punto de equilibrio, y con el nombre plate###-k.bin donde k corresponde al n√∫mero de estado donde se alcanz√≥ el equilibrio. Este archivo tiene el mismo formato que cualquier otro archivo de l√°mina, y por lo tanto, podr√≠a ser usado como punto de partida de nuevas simulaciones.


Nota: Usted debe decidir d√≥nde se escriben los archivos de resultado. Se ofrecen a continuaci√≥n tres alternativas no excluyentes.

- En la carpeta actual. Los archivos de resultado se escriben siempre en la carpeta actual, es decir, de d√≥nde se llama al ejecutable. Se puede suponer que en esa carpeta actual tienen permisos de escritura. Por ejemplo:

[source, TXT]
--
cd /path/to/proy02
mkdir output
cd output
../bin/proy02 job.txt 8 /path/to/input
Provocar√≠a que el programa lea la orden de trabajo /path/to/input/job.txt, con l√°minas como /path/to/input/plate.bin, y escriba los archivos de salida en /path/to/proy02/output/.
--

- En la misma carpeta de entrada. El reporte se escribe en la misma carpeta donde se encuentra el archivo de trabajo. Para este fin puede hacer manipulaci√≥n de cadenas de caracteres, o usar el tercer argumento de l√≠nea de comandos.

- Cuarto argumento. Agregar un cuarto argumento de l√≠nea de comandos que indique la ruta donde se escriben los archivos de salida, por ejemplo:

[source, TXT]
--
bin/heatsim job001.txt 16 tests output
--

Realizar√≠a el trabajo tests/job001.txt, con l√°minas como tests/plate001.bin, y escribir√≠a el reporte en output/job001.tsv y l√°minas resultantes como output/plate001-2.bin.

=== Archivo de l√°mina

Las l√°minas son matrices que se almacenan en archivos binarios que tienen una estructura sencilla. Los primeros ocho bytes son un entero sin signo ùëÖ que indica la cantidad de filas de la matriz. Los segundos ocho bytes son un entero sin signo ùê∂ que indica la cantidad de columnas de la matriz. A partir de los 16 bytes anteriores, contin√∫an ùëÖ‚ãÖùê∂ n√∫meros flotantes de doble precisi√≥n con la temperatura inicial de cada una de las celdas de la matriz, en el orden habitual de filas y columnas. Todos los valores se encuentran en little-endian.

Nota: Su c√≥digo fuente debe emplear entrada y salida binaria y no de texto. Por ejemplo, en C se deben usar los procedimientos fread() y fwrite() en lugar de entrada y salida con formato como scanf() y printf().

mportante: Las matrices que las personas investigadoras simulen pueden ser muy grandes debido a la necesidad de una alta granularidad para poder acercar la fidelidad de la simulaci√≥n a la realidad. Su programa debe hacer un cuidadoso y eficiente manejo de memoria y de errores.


=== Referencias
Becker and Kaus (2016). Excerpt from GEOL557 Numerical Modeling of Earth Systems. Accedido Nov, 2021.


Input example:

[source]
----
include::tests/input001.txt[]
----

Output example:

[source]
----
include::tests/output001.txt[]
----

[[design]]
== Design of solution

#See the link:design/readme.adoc[design/] folder for an overall design of the solution.#


[[user_manual]]
== User manual

[[build]]
=== Build

#Describe how to compile your solution.#

[[usage]]
=== Usage

#Describe how to run your solution, e.g: arguments. Provide examples.#


[[credits]]
== Credits

#Provide your contact information.#

#Give credit to authors of libraries, images, sounds, or any resource you used.#
